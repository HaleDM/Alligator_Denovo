Denovo_Assembly Pipeline
Attempting to develop a pipeline for the QC, assembly, and DEG analysis of alligator RNAseq reads in a de novo fashion
for later use in de novo transcriptome assembly of Ambystoma opacum RNAseq reads

#Upon researching methods and approaches for de novo transcriptome analysis, I found a resource
#from the Harvard FAS Informatics core (https://informatics.fas.harvard.edu/best-practices-for-de-novo-transcriptome-assembly-with-trinity.html)
#that outlined a robust and rigorous approach to de novo assembly using Trinity, a well-maintained and popular assembler
#that relies on De Brujin's graphs and Kmer assembly. The Harvard resource suggests using a QC and trimming tool called
#rCorrector to remove erroneous kMers from Illumina reads prior to utilization in assembly. Because we are using
#the same RNAseq reads from STIM2014, for which I have assessed quality via Fast/MultiQC, this step *shouldn't*
#be necessary. But because we are building this pipeline for a yet-untested read-set, I'm going to start with 
#this step anyway. At best, it will identify possible unforeseen QC issues in our STIM RNAseq reads and improve
#Ambystoma assembly generation, and at worst it will take up a little bit of time and not actually be helpful.

#Below is a working test script that I ran against one sample for rCorrector. This program
#corrects rare Kmers that are usually either sequencing errors or very rare transcripts
#This presents a trade-off, then, but rare transcripts are likely not going to be assembled
#anyway

#PBS -S /bin/bash
#PBS -q batch
#PBS -N rCorrector1.3test
#PBS -l nodes=1:ppn=1
#PBS -l walltime=48:00:00
#PBS -l mem=20gb

cd /lustre1/mdh72859/Denovo_Assembly
module load Rcorrector/1.0.2-foss-2016b
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L004_R2_001.fastq > rCorrector_134.log

#It appears to have worked:
Processed 29459422 reads
	Corrected 4456109 bases.
	
#This test script was scaled up and applied to all 8 samples
#PBS -S /bin/bash
#PBS -q batch
#PBS -M matthew.hale@uga.edu 
#PBS -m ae
#PBS -N rCorrector1.0
#PBS -l nodes=1:ppn=4
#PBS -l walltime=48:00:00
#PBS -l mem=20gb

cd /lustre1/mdh72859/Denovo_Assembly
mkdir rCorrector_Output
cd rCorrector_Output
module load Rcorrector/1.0.2-foss-2016b
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-110-47576580/138599-110_S27_L004_R2_001.fastq -t 4 > rCorrector_110.log
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-134-47587572/138599-134_S21_L004_R2_001.fastq -t 4 > rCorrector_134.log
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-23-47580598/138599-23_S22_L004_R2_001.fastq -t 4 > rCorrector_23.log
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-63-47586581/138599-63_S23_L004_R2_001.fastq -t 4 > rCorrector_63.log
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-68-47581561/138599-68_S18_L004_R2_001.fastq -t 4 > rCorrector_68.log
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-69-47569618/138599-69_S24_L004_R2_001.fastq -t 4 > rCorrector_69.log
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-8-47580595/138599-8_S15_L004_R2_001.fastq -t 4 > rCorrector_8.log
run_rcorrector.pl -1 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L001_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L002_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L003_R1_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L004_R1_001.fastq -2 /lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L001_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L002_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L003_R2_001.fastq,/lustre1/mdh72859/Denovo_Assembly/Fastq_Reads/138599-90-47571617/138599-90_S19_L004_R2_001.fastq -t 4 > rCorrector_90.log

#To clean the rCorrector output into a format ready for use in Trinity, I'm using a python script from Harvard 
#(https://informatics.fas.harvard.edu/best-practices-for-de-novo-transcriptome-assembly-with-trinity.html)
#It is usable in the command line by:
>python FilterUncorrectabledPEfastq.py -1 $1 -2 $2 -o fixed 2>&1 > rmunfixable_$r1.out
#Where $1 is the name of your forward read and $2 is the name of your reverse read
#-o will add the following string as a prefix to the output file (left as "fixed")
#What follows ">" is the name for a log file just just tells the number of processed reads
#Python script is pasted below
"""
author: adam h freedman
afreedman405 at gmail.com
data: Fri Aug 26 10:55:18 EDT 2016
This script takes as an input Rcorrector error corrected Illumina paired-reads
in fastq format and:
1. Removes any reads that Rcorrector indentifes as containing an error,
but can't be corrected, typically low complexity sequences. For these,
the header contains 'unfixable'.
2. Strips the ' cor' from headers of reads that Rcorrector fixed, to avoid
issues created by certain header formats for downstream tools.
3. Write a log with counts of (a) read pairs that were removed because one end
was unfixable, (b) corrected left and right reads, (c) total number of
read pairs containing at least one corrected read.
Currently, this script only handles paired-end data, and handle either unzipped
or gzipped files on the fly, so long as the gzipped files end with 'gz'.
"""

import sys        
import gzip
from itertools import izip,izip_longest
import argparse
from os.path import basename

def get_input_streams(r1file,r2file):
    if r1file[-2:]=='gz':
        r1handle=gzip.open(r1file,'rb')
        r2handle=gzip.open(r2file,'rb')
    else:
        r1handle=open(r1file,'r')
        r2handle=open(r2file,'r')
    
    return r1handle,r2handle
        
        
def grouper(iterable, n, fillvalue=None):
    "Collect data into fixed-length chunks or blocks"
    # grouper('ABCDEFG', 3, 'x') --> ABC DEF Gxx
    args = [iter(iterable)] * n
    return izip_longest(fillvalue=fillvalue, *args)  
    

if __name__=="__main__": 
    parser = argparse.ArgumentParser(description="options for filtering and logging rCorrector fastq outputs")
    parser.add_argument('-1','--left_reads',dest='leftreads',type=str,help='R1 fastq file')
    parser.add_argument('-2','--right_reads',dest='rightreads',type=str,help='R2 fastq file')
    parser.add_argument('-o','--out_prefix',dest='outprefix',type=str,help="prefix for filtered fastq output")
    opts = parser.parse_args()

    r1out=open(opts.outprefix+'_'+basename(opts.leftreads).replace('.gz',''),'w')
    r2out=open(opts.outprefix+'_'+basename(opts.rightreads).replace('.gz','') ,'w')

    r1_cor_count=0
    r2_cor_count=0
    pair_cor_count=0
    unfix_count=0   

    r1_stream,r2_stream=get_input_streams(opts.leftreads,opts.rightreads)

    with r1_stream as f1, r2_stream as f2:
        R1=grouper(f1,4)
        R2=grouper(f2,4)
        counter=0
        for entry in R1:
            counter+=1
            if counter%100000==0:
                print "%s reads processed" % counter
        
            head1,seq1,placeholder1,qual1=[i.strip() for i in entry]
            head2,seq2,placeholder2,qual2=[j.strip() for j in R2.next()]
            
            if 'unfixable' in head1 or 'unfixable' in head2:
                unfix_count+=1
            else:
                if 'cor' in head1:
                    r1_cor_count+=1
                if 'cor' in head2:
                    r2_cor_count+=1
                if 'cor' in head1 or 'cor' in head2:
                    pair_cor_count+=1
                
                head1=head1.split('l:')[0][:-1] # keeps all before the low kmer count statistic and removes the trailing whitespace character
                head2=head2.split('l:')[0][:-1] 
                #head1=head1.replace(' cor','')
                #head2=head2.replace(' cor','')
                r1out.write('%s\n' % '\n'.join([head1,seq1,placeholder1,qual1]))
                r2out.write('%s\n' % '\n'.join([head2,seq2,placeholder2,qual2]))

    unfix_log=open('rmunfixable.log','w')
    unfix_log.write('total PE reads:%s\nremoved PE reads:%s\nretained PE reads:%s\nR1 corrected:%s\nR2 corrected:%s\npairs corrected:%s\n' % (counter,unfix_count,counter-unfix_count,r1_cor_count,r2_cor_count,pair_cor_count))
            
    r1out.close()
    r2out.close() 
#The above script is being used in a local shell script (not run through cluster, just locally)
#Write and copy script to same directory as rCorrector Output

#FastQFilter.sh is as follows below:
python FilterUncorrectablePEfastq.py -1 138599-134_S21_L001_R1_001.cor.fq -2 138599-134_S21_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_134_1.out
python FilterUncorrectablePEfastq.py -1 138599-134_S21_L002_R1_001.cor.fq -2 138599-134_S21_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_134_2.out
python FilterUncorrectablePEfastq.py -1 138599-134_S21_L003_R1_001.cor.fq -2 138599-134_S21_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_134_3.out
python FilterUncorrectablePEfastq.py -1 138599-134_S21_L004_R1_001.cor.fq -2 138599-134_S21_L004_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_134_4.out

python FilterUncorrectablePEfastq.py -1 138599-110_S27_L001_R1_001.cor.fq -2 138599-110_S27_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_110_1.out
python FilterUncorrectablePEfastq.py -1 138599-110_S27_L002_R1_001.cor.fq -2 138599-110_S27_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_110_2.out
python FilterUncorrectablePEfastq.py -1 138599-110_S27_L003_R1_001.cor.fq -2 138599-110_S27_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_110_3.out
python FilterUncorrectablePEfastq.py -1 138599-110_S27_L004_R1_001.cor.fq -2 138599-110_S27_L004_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_110_4.out

python FilterUncorrectablePEfastq.py -1 138599-23_S22_L001_R1_001.cor.fq -2 138599-23_S22_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_23_1.out
python FilterUncorrectablePEfastq.py -1 138599-23_S22_L002_R1_001.cor.fq -2 138599-23_S22_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_23_2.out
python FilterUncorrectablePEfastq.py -1 138599-23_S22_L003_R1_001.cor.fq -2 138599-23_S22_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_23_3.out
python FilterUncorrectablePEfastq.py -1 138599-23_S22_L004_R1_001.cor.fq -2 138599-23_S22_L004_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_23_4.out

python FilterUncorrectablePEfastq.py -1 138599-63_S23_L001_R1_001.cor.fq -2 138599-63_S23_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_63_1.out
python FilterUncorrectablePEfastq.py -1 138599-63_S23_L002_R1_001.cor.fq -2 138599-63_S23_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_63_2.out
python FilterUncorrectablePEfastq.py -1 138599-63_S23_L003_R1_001.cor.fq -2 138599-63_S23_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_63_3.out
python FilterUncorrectablePEfastq.py -1 138599-63_S23_L004_R1_001.cor.fq -2 138599-63_S23_L004_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_63_4.out

python FilterUncorrectablePEfastq.py -1 138599-68_S18_L001_R1_001.cor.fq -2 138599-68_S18_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_68_1.out
python FilterUncorrectablePEfastq.py -1 138599-68_S18_L002_R1_001.cor.fq -2 138599-68_S18_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_68_2.out
python FilterUncorrectablePEfastq.py -1 138599-68_S18_L003_R1_001.cor.fq -2 138599-68_S18_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_68_3.out
python FilterUncorrectablePEfastq.py -1 138599-68_S18_L004_R1_001.cor.fq -2 138599-68_S18_L004_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_68_4.out

python FilterUncorrectablePEfastq.py -1 138599-69_S24_L001_R1_001.cor.fq -2 138599-69_S24_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_69_1.out
python FilterUncorrectablePEfastq.py -1 138599-69_S24_L002_R1_001.cor.fq -2 138599-69_S24_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_69_2.out
python FilterUncorrectablePEfastq.py -1 138599-69_S24_L003_R1_001.cor.fq -2 138599-69_S24_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_69_3.out
python FilterUncorrectablePEfastq.py -1 138599-69_S24_L004_R1_001.cor.fq -2 138599-69_S24_L004_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_69_4.out

python FilterUncorrectablePEfastq.py -1 138599-8_S15_L001_R1_001.cor.fq -2 138599-8_S15_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_8_1.out
python FilterUncorrectablePEfastq.py -1 138599-8_S15_L002_R1_001.cor.fq -2 138599-8_S15_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_8_2.out
python FilterUncorrectablePEfastq.py -1 138599-8_S15_L003_R1_001.cor.fq -2 138599-8_S15_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_8_3.out
python FilterUncorrectablePEfastq.py -1 138599-8_S15_L004_R1_001.cor.fq -2 138599-8_S15_L004_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_8_4.out

python FilterUncorrectablePEfastq.py -1 138599-90_S19_L001_R1_001.cor.fq -2 138599-90_S19_L001_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_90_1.out
python FilterUncorrectablePEfastq.py -1 138599-90_S19_L002_R1_001.cor.fq -2 138599-90_S19_L002_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_90_2.out
python FilterUncorrectablePEfastq.py -1 138599-90_S19_L003_R1_001.cor.fq -2 138599-90_S19_L003_R2_001.cor.fq -o fixed 2>&1 > rmunfixable_90_3.out

08/23/18
#rCorrector worked. Now want to run TrimGalore, which is on both Sapelo and Sapelo2

#What follows is TrimGalore test script

#PBS -S /bin/bash
#PBS -N TrimGalore1.0test
#PBS -q batch
#PBS -l nodes=1:ppn=1:AMD
#PBS -l walltime=48:00:00
#PBS -l mem=10gb

cd /lustre1/mdh72859/Denovo_Assembly
mkdir TrimGalore_Fastqc

module load Trim_Galore/0.4.5-foss-2016b
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc/ -f fastq" -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L001_R2_001.cor.fq

#--fastqc calls to run fastqc after trimming
#--fastqc args calls what follows in quotes as arguments for fastqc, outdir specifying where to put the report and -f fastq specifying fastq input
#--paired tells trimgalore that following input reads are paired, which affects how pairs are kept or thrown out (won't orphan a read if mate is shite)
#This test worked, operating in ~6minutes on two input fastq. Need to scale this up to multiple lanes and multiple samples.

#it is both interesting and good to note that TrimGalore found some degree of adapter contamination, which means I should probably
#revisit the STIM RNAseq reads. Output summary for one read is pasted below:
=== Summary ===

Total reads processed:               3,563,396
Reads with adapters:                   420,668 (11.8%)
Reads written (passing filters):     3,563,396 (100.0%)

Total basepairs processed:   268,927,030 bp
Quality-trimmed:                 637,802 bp (0.2%)
Total written (filtered):    267,743,591 bp (99.6%)

=== Adapter 1 ===

Sequence: AGATCGGAAGAGC; Type: regular 3'; Length: 13; Trimmed: 420668 times.

No. of allowed errors:
0-9 bp: 0; 10-13 bp: 1

Bases preceding removed adapters:
  A: 35.6%
  C: 28.0%
  G: 18.7%
  T: 17.7%
  none/other: 0.0%

Overview of removed sequences
length	count	expect	max.err	error counts
1	345639	890849.0	0	345639
2	40984	222712.2	0	40984
3	28173	55678.1	0	28173
4	3991	13919.5	0	3991
5	1567	3479.9	0	1567
6	60	870.0	0	60
7	10	217.5	0	10
8	1	54.4	0	1
9	9	13.6	0	1 8
10	10	3.4	1	1 9
11	5	0.8	1	0 5
12	7	0.2	1	0 7
14	5	0.1	1	0 5
15	3	0.1	1	0 3
16	3	0.1	1	1 2
17	2	0.1	1	0 2
18	7	0.1	1	2 5
19	2	0.1	1	0 2
20	11	0.1	1	2 9
21	3	0.1	1	2 1
22	2	0.1	1	0 2
23	3	0.1	1	0 3
24	5	0.1	1	1 4
25	6	0.1	1	1 5
26	6	0.1	1	1 5
27	5	0.1	1	1 4
28	4	0.1	1	0 4
29	2	0.1	1	0 2
30	3	0.1	1	0 3
31	1	0.1	1	0 1
32	9	0.1	1	1 8
33	4	0.1	1	0 4
34	3	0.1	1	1 2
35	1	0.1	1	0 1
36	2	0.1	1	0 2
37	5	0.1	1	0 5
38	2	0.1	1	0 2
39	6	0.1	1	0 6
40	1	0.1	1	0 1
41	1	0.1	1	0 1
42	5	0.1	1	0 5
43	5	0.1	1	0 5
44	1	0.1	1	0 1
46	1	0.1	1	0 1
47	1	0.1	1	0 1
48	2	0.1	1	0 2
49	5	0.1	1	0 5
50	3	0.1	1	0 3
51	15	0.1	1	0 15
52	2	0.1	1	0 2
53	2	0.1	1	0 2
54	4	0.1	1	0 4
55	4	0.1	1	0 4
56	1	0.1	1	0 1
57	2	0.1	1	0 2
59	2	0.1	1	0 2
60	3	0.1	1	0 3
61	5	0.1	1	0 5
63	4	0.1	1	0 4
64	3	0.1	1	0 3
65	2	0.1	1	0 2
66	4	0.1	1	0 4
67	5	0.1	1	0 5
68	1	0.1	1	0 1
69	2	0.1	1	0 2
70	1	0.1	1	0 1
71	7	0.1	1	0 7
72	2	0.1	1	0 2
73	5	0.1	1	0 5
74	3	0.1	1	0 3
75	2	0.1	1	0 2
76	1	0.1	1	0 1

#PBS -S /bin/bash
#PBS -N TrimGalore2.0
#PBS -q batch
#PBS -l nodes=1:ppn=1:AMD
#PBS -l walltime=6:00:00
#PBS -l mem=10gb

cd /lustre1/mdh72859/Denovo_Assembly
mkdir TrimGalore_Fastqc2

cd TrimGalore_Fastqc2
mkdir 110
cd /lustre1/mdh72859/Denovo_Assembly
module load Trim_Galore/0.4.5-foss-2016b

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/110/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-110_S27_L004_R2_001.cor.fq

cd TrimGalore_Fastqc2
mkdir 134
cd /lustre1/mdh72859/Denovo_Assembly

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/134/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-134_S21_L004_R2_001.cor.fq

cd TrimGalore_Fastqc2
mkdir 23
cd /lustre1/mdh72859/Denovo_Assembly

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/23/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-23_S22_L004_R2_001.cor.fq

cd TrimGalore_Fastqc2
mkdir 63
cd /lustre1/mdh72859/Denovo_Assembly

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/63/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-63_S23_L004_R2_001.cor.fq

cd TrimGalore_Fastqc2
mkdir 68
cd /lustre1/mdh72859/Denovo_Assembly

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/68/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-68_S18_L004_R2_001.cor.fq

cd TrimGalore_Fastqc2
mkdir 69
cd /lustre1/mdh72859/Denovo_Assembly

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/69/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-69_S24_L004_R2_001.cor.fq

cd TrimGalore_Fastqc2
mkdir 8
cd /lustre1/mdh72859/Denovo_Assembly

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/8/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-8_S15_L004_R2_001.cor.fq

cd TrimGalore_Fastqc2
mkdir 90
cd /lustre1/mdh72859/Denovo_Assembly

trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L001_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L001_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L002_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L002_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L003_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L003_R2_001.cor.fq
trim_galore --fastqc --fastqc_args "--outdir /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ -f fastq" -stringency 3 -o /lustre1/mdh72859/Denovo_Assembly/TrimGalore_Fastqc2/90/ --paired /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L004_R1_001.cor.fq /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output/fixed_138599-90_S19_L004_R2_001.cor.fq

#As a minor sidestep, attempting to visualize alignment data to see if our reads are stranded or not
#Using an alignment previously done for STIM RNAseq analysis to test this using IGV to visualize
#This requires a .BAM file and an index of that .BAM file, or .BAI, which Samtools can generate.

mkdir Bam_test
cp /lustre1/mdh72859/Analysis_051418/Hisat2_Alignments/101/101_Sorted.bam /lustre1/mdh72859/Denovo_Assembly/Bam_test

#PBS -S /bin/bash
#PBS -N Samtools_Index1.0.sh
#PBS -q batch
#PBS -l nodes=1:ppn=1:AMD
#PBS -l mem=20gb
#PBS -l walltime=480:00:00

cd /lustre1/mdh72859/Denovo_Assembly/Bam_test
module load SAMtools/1.6-foss-2016b
time samtools index 101_Sorted.bam 101_Sorted.bai

##Generally successful at adding alignment and viewing in IGV, but going to try to address strandedness more directly
##by using Salmon.

#First step is to generate an index for the RNAseq ovarian transcriptome generated by MDH
#Should also generate one for the alligator genome to confirm process works

#PBS -S /bin/bash
#PBS -q batch
#PBS -N Salmon_test_index2.0
#PBS -l nodes=1:ppn=1:AMD
#PBS -l walltime=480:00:00
#PBS -l mem=10gb

cd /lustre1/mdh72859/Denovo_Assembly/Salmon

module load Salmon/0.8.2-foss-2016b-Python-2.7.14
salmon index -t transcripts.fa -i transcripts.index --type quasi -k 31

#Index generation worked.

#Second step is to run quantification in Salmon with the "-l A" option that tells the program
#to detect and report information on library type. We really don't care much about transcript quantification,
#which Salmon is designed to do, but it might be helpful to revisit this later to compare transcript levels

#First had to manually move reads for one sample to test, 110, into directory with script. Then, ran Salmon

#PBS -S /bin/bash
#PBS -q batch
#PBS -N Salmon_test2.0
#PBS -l nodes=1:ppn=1:AMD
#PBS -l walltime=480:00:00
#PBS -l mem=10gb

cd /lustre1/mdh72859/Denovo_Assembly/Salmon
mkdir Salmon_Quant2
module load Salmon/0.8.2-foss-2016b-Python-2.7.14
salmon quant -i transcripts.index -l A -1 138599-110_S27_L001_R1_001.fastq 138599-110_S27_L002_R1_001.fastq 138599-110_S27_L003_R1_001.fastq 138599-110_S27_L004_R1_001.fastq -2 138599-110_S27_L001_R2_001.fastq 138599-110_S27_L002_R2_001.fastq 138599-110_S27_L003_R2_001.fastq 138599-110_S27_L004_R2_001.fastq -o Salmon_Quant2/110

#The -l A parameter call above is necessary to get strandedness information for the input library
#Some output summary is pasted below:

processed 15000000 fragmentsointLog] [info] Automatically detected most likely library type as ISR
hits: 44234640, hits per frag:  2.96882

[2018-08-07 11:42:19.700] [jointLog] [info] Computed 138679 rich equivalence classes for further processing
[2018-08-07 11:42:19.700] [jointLog] [info] Counted 12477680 total reads in the equivalence classes 

read_files": "( 138599-110_S27_L001_R1_001.fastq, 138599-110_S27_L001_R2_001.fastq ), ( 138599-110_S27_L002_R1_001.fastq, 138599-110_S27_L002_R2_001.fastq ), ( 138599-110_S27_L003_R1_001.fastq, 138599-110
_S27_L003_R2_001.fastq ), ( 138599-110_S27_L004_R1_001.fastq, 138599-110_S27_L004_R2_001.fastq )",
    "expected_format": "ISR",
    "compatible_fragment_ratio": 0.9087333542773978,
    "num_compatible_fragments": 11338884,
    "num_assigned_fragments": 12477680,
    "num_consistent_mappings": 41467204,
    "num_inconsistent_mappings": 2913210,
    "MSF": 0,
    "OSF": 1191,
    "ISF": 1272425,
    "MSR": 0,
    "OSR": 17614,
    "ISR": 41467204,
    "SF": 255748,
    "SR": 1365267,
    "MU": 0,
    "OU": 0,
    "IU": 0,
    "U": 0
    
#Now going to scale up to get same information for other samples' reads
#First moved copies of fastq reads into same directory without sample-specific subdirectories

#PBS -S /bin/bash
#PBS -q batch
#PBS -N Salmon1.1
#PBS -l nodes=1:ppn=1:AMD
#PBS -l walltime=480:00:00
#PBS -l mem=10gb

cd /lustre1/mdh72859/Denovo_Assembly/Salmon
mkdir Salmon_Quant2
module load Salmon/0.8.2-foss-2016b-Python-2.7.14
salmon quant -i transcripts.index -l A -1 138599-110_S27_L001_R1_001.fastq 138599-110_S27_L002_R1_001.fastq 138599-110_S27_L003_R1_001.fastq 138599-110_S27_L004_R1_001.fastq -2 138599-110_S27_L001_R2_001.fastq 138599-110_S27_L002_R2_001.fastq 138599-110_S27_L003_R2_001.fastq 138599-110_S27_L004_R2_001.fastq -o Salmon_Quant2/110
salmon quant -i transcripts.index -l A -1 138599-134_S21_L001_R1_001.fastq 138599-134_S21_L002_R1_001.fastq 138599-134_S21_L003_R1_001.fastq 138599-134_S21_L004_R1_001.fastq -2 138599-134_S21_L001_R2_001.fastq 138599-134_S21_L002_R2_001.fastq 138599-134_S21_L003_R2_001.fastq 138599-134_S21_L004_R2_001.fastq -o Salmon_Quant2/134
salmon quant -i transcripts.index -l A -1 138599-23_S22_L001_R1_001.fastq 138599-23_S22_L002_R1_001.fastq 138599-23_S22_L003_R1_001.fastq 138599-23_S22_L004_R1_001.fastq -2 138599-23_S22_L001_R2_001.fastq 138599-23_S22_L002_R2_001.fastq 138599-23_S22_L003_R2_001.fastq 138599-23_S22_L004_R2_001.fastq -o Salmon_Quant2/23
salmon quant -i transcripts.index -l A -1 138599-63_S23_L001_R1_001.fastq 138599-63_S23_L002_R1_001.fastq 138599-63_S23_L003_R1_001.fastq 138599-63_S23_L004_R1_001.fastq -2 138599-63_S23_L001_R2_001.fastq 138599-63_S23_L002_R2_001.fastq 138599-63_S23_L003_R2_001.fastq 138599-63_S23_L004_R2_001.fastq -o Salmon_Quant2/63
salmon quant -i transcripts.index -l A -1 138599-68_S18_L001_R1_001.fastq 138599-68_S18_L002_R1_001.fastq 138599-68_S18_L003_R1_001.fastq 138599-68_S18_L004_R1_001.fastq -2 138599-68_S18_L001_R2_001.fastq 138599-68_S18_L002_R2_001.fastq 138599-68_S18_L003_R2_001.fastq 138599-68_S18_L004_R2_001.fastq -o Salmon_Quant2/68
salmon quant -i transcripts.index -l A -1 138599-69_S24_L001_R1_001.fastq 138599-69_S24_L002_R1_001.fastq 138599-69_S24_L003_R1_001.fastq 138599-69_S24_L004_R1_001.fastq -2 138599-69_S24_L001_R2_001.fastq 138599-69_S24_L002_R2_001.fastq 138599-69_S24_L003_R2_001.fastq 138599-69_S24_L004_R2_001.fastq -o Salmon_Quant2/69
salmon quant -i transcripts.index -l A -1 138599-8_S15_L001_R1_001.fastq 138599-8_S15_L002_R1_001.fastq 138599-8_S15_L003_R1_001.fastq 138599-8_S15_L004_R1_001.fastq -2 138599-8_S15_L001_R2_001.fastq 138599-8_S15_L002_R2_001.fastq 138599-8_S15_L003_R2_001.fastq 138599-8_S15_L004_R2_001.fastq -o Salmon_Quant2/8
salmon quant -i transcripts.index -l A -1 138599-90_S19_L001_R1_001.fastq 138599-90_S19_L002_R1_001.fastq 138599-90_S19_L003_R1_001.fastq 138599-90_S19_L004_R1_001.fastq -2 138599-90_S19_L001_R2_001.fastq 138599-90_S19_L002_R2_001.fastq 138599-90_S19_L003_R2_001.fastq 138599-90_S19_L004_R2_001.fastq -o Salmon_Quant2/90

#This ran to completion, requiring ~2.5 hours to finish for all 8 samples.
#All eight libraries appear to be predominantly (89-91%) "ISR", or inward facing, stranded reads
#where the forward/1st read falls on the reverse strand.

08/16/18
##Moving forward with Trinity assembly
##Starting with single-sample test script

#PBS -S /bin/bash
#PBS -N Trinity1.0test
#PBS -q highmem_q
#PBS -l nodes=1:ppn=16
#PBS -l walltime=100:00:00
#PBS -l mem=100gb

cd /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output
module load Trinity/2.6.6-foss-2016b
Trinity --seqType fq --max_memory 100G --CPU 8 --no_version_check --full_cleanup --normalize_reads --left fixed_138599-134_S21_L001_R1_001.cor.fq,fixed_138599-134_S21_L002_R1_001.cor.fq,fixed_138599-134_S21_L003_R1_001.cor.fq,fixed_138599-134_S21_L004_R1_001.cor.fq --right fixed_138599-134_S21_L001_R2_001.cor.fq,fixed_138599-134_S21_L002_R2_001.cor.fq,fixed_138599-134_S21_L003_R2_001.cor.fq,fixed_138599-134_S21_L004_R2_001.cor.fq --output /lustre1/mdh72859/Denovo_Assembly/trinity_134_test

#This ran successfully for ~2 hours of wall-time, until encountering a fatal error at the final Trinity assembly step.
#Error message is detailed below:

Error, cmd: bash -c " set -o pipefail;/usr/local/apps/eb/Bowtie2/2.3.3-foss-2016b/bin/bowtie2 --local -k 2 --no-unal --threads 8 -f --score-min G,20,4 -x /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/chrysalis/inchworm.K25.L25.DS.fa.min100 /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/both.fa  | samtools view -@ 8 -F4 -Sb - | samtools sort -m 6710886400 -@ 8 -no - - > /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/chrysalis/iworm.bowtie.nameSorted.bam"  2>tmp.49836.stderr died with ret 256 at /usr/local/apps/eb/Trinity/2.6.6-foss-2016b/trinityrnaseq-Trinity-v2.6.6/PerlLib/Pipeliner.pm line 166.
	Pipeliner::run(Pipeliner=HASH(0x12de5a0)) called at /usr/local/apps/eb/Trinity/2.6.6-foss-2016b/trinityrnaseq-Trinity-v2.6.6/Trinity line 1864
	main::run_chrysalis("/lustre1/mdh72859/Denovo_Assembly/trinity_134_test/inchworm.K"..., "/lustre1/mdh72859/Denovo_Assembly/trinity_134_test/both.fa", 200, 500, undef, "/lustre1/mdh72859/Denovo_Assembly/trinity_134_test/both.fa", "/lustre1/mdh72859/Denovo_Assembly/trinity_134_test/both.fa") called at /usr/local/apps/eb/Trinity/2.6.6-foss-2016b/trinityrnaseq-Trinity-v2.6.6/Trinity line 1664
	main::run_Trinity() called at /usr/local/apps/eb/Trinity/2.6.6-foss-2016b/trinityrnaseq-Trinity-v2.6.6/Trinity line 1317
	eval {...} called at /usr/local/apps/eb/Trinity/2.6.6-foss-2016b/trinityrnaseq-Trinity-v2.6.6/Trinity line 1316

Trinity run failed. Must investigate error above.

#breaking down the first line of error message above, starting with "Error, cmd: bash -c"
Error, cmd: bash -c " set -o pipefail;/usr/local/apps/eb/Bowtie2/2.3.3-foss-2016b/bin/bowtie2 
--local -k 2 --no-unal --threads 8 -f --score-min G,20,4 -x /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/chrysalis/inchworm.K25.L25.DS.fa.min100 /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/both.fa  | samtools view -@ 8 -F4 -Sb - | samtools sort -m 6710886400 -@ 8 -no - - > /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/chrysalis/iworm.bowtie.nameSorted.bam"  2>tmp.49836.stderr died with ret 256 at /usr/local/apps/eb/Trinity/2.6.6-foss-2016b/trinityrnaseq-Trinity-v2.6.6/PerlLib/Pipeliner.pm line 166.

#This appears to be calling bowtie2
-x /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/chrysalis/inchworm.K25.L25.DS.fa.min100
#This is the index parameter call. The directory chrysalis is full of .bt2 index files, and the inchworm.K25.L25.DS.fa.min100 file is present
/lustre1/mdh72859/Denovo_Assembly/trinity_134_test/both.fa
#This should be the input to bowtie. It is present and has sequences.
  | samtools view -@ 8 -F4 -Sb - | samtools sort -m 6710886400 -@ 8 -no - - > /lustre1/mdh72859/Denovo_Assembly/trinity_134_test/chrysalis/iworm.bowtie.nameSorted.bam"
#Next line is using samtools, generating an output .BAM called "iworm.bowtie.nameSorted.bam". This file is present and contains data.
#These leaves the following chunk below, which looks like a good culprit:
2>tmp.49836.stderr died with ret 256 at /usr/local/apps/eb/Trinity/2.6.6-foss-2016b/trinityrnaseq-Trinity-v2.6.6/PerlLib/Pipeliner.pm line 166.
#What is Pipeliner.pm and why did it fail at line 166?


#Need to dig into Pipeliner and contact GACRC. Going to make a small correction that I don't think will
#fix it (adding --SS_lib_type RF) and will let test re-run overnight.

08/17/18
#Not sure what fixed it. I contacted GACRC, and they got back to me that the Trinity failure was most
#likely a Bowtie bug. They updated versions and told me to rerun the same script....after I had already
#restarted the script with the new --SS_lib_type RF parameter. But anyway, the script seemed to have
#worked. It took 86 hours of walltime for ONE sample, but generated the expected assembly.

#Correction. Trinity did NOT work (or did it? Idfk). Inspecting fasta headers reveals an issue
>TRINITY_DN22188_c0_g1_i1 len=213 path=[0:0-212]
#this is the typical fasta header for all the assembled transcripts. There are 80,068 of these.
#The header gives important info on the "gene" and "transcript", Trinity cluster, and location.
TRINITY_DN22188: Trinity cluster DN22188 c0. 
g1: gene 1
i1: isoform 1
#There are 61,1123 g1 transcripts. There are 59,989 c0 clusters. Clusters SHOULD be made up by
#highly similar transcripts, ergo a cluster is a loose definition of a gene. According to this output,
#close to 3/4 of ALL transcripts assembled belong to the same "gene", c0. Trinity groups transcripts into clusters by shared sequence content.
#I could be wrong, however. Continued reading shows that in reality, the entire string up to isoform identifies
#genes, e.g DN22188_c0_g1 is a unique gene. So long as there isn't another DN22188_c0_g1, this is a unique
#cluster of transcripts 
#Need to determine assembly quality to know with some confidence if this worked or if it didn't.
#Tools that keep getting brought up: Detonate, Busco, and a series of tools in Trinity.


/usr/local/apps/eb/Trinity/2014-07-17-foss-2016b/trinityrnaseq_r20140717/util/TrinityStats.pl trinity_134_test2.Trinity.fasta > Trinity_assembly.metrics

################################
## Counts of transcripts, etc.
################################
Total trinity 'genes':	62659
Total trinity transcripts:	80068
Percent GC: 47.49

########################################
Stats based on ALL transcript contigs:
########################################

	Contig N10: 5141
	Contig N20: 4063
	Contig N30: 3286
	Contig N40: 2697
	Contig N50: 2139

	Median contig length: 461
	Average contig: 1017.64
	Total assembled bases: 81480760 #81m assembled bases


#####################################################
## Stats based on ONLY LONGEST ISOFORM per 'GENE':
#####################################################

	Contig N10: 4935  #10% of all bases are in contigs at least 4935bp long
	Contig N20: 3856 
	Contig N30: 3111
	Contig N40: 2474
	Contig N50: 1882  #50% of all bases are in contigs at least 1882bp long

	Median contig length: 392
	Average contig: 872.83
	Total assembled bases: 54690653

#So maybe not all that bad!

#Wrote a longer script to repeat the above Trinity summary above and do another after aligning
#raw reads to the new assembly

#PBS -S /bin/bash
#PBS -N TrinityAssembly_QualityTest1.1
#PBS -q batch
#PBS -l nodes=1:ppn=1
#PBS -l walltime=100:00:00
#PBS -l mem=10gb

cd /lustre1/mdh72859/Denovo_Assembly
mkdir TrinityAssembly_Quality
cd /lustre1/mdh72859/Denovo_Assembly/rCorrector_Output
cp fixed_138599-134* /lustre1/mdh72859/Denovo_Assembly/TrinityAssembly_Quality
cd /lustre1/mdh72859/Denovo_Assembly
cp trinity_134_test2.Trinity.fasta /lustre1/mdh72859/Denovo_Assembly/TrinityAssembly_Quality

cd /lustre1/mdh72859/Denovo_Assembly/TrinityAssembly_Quality
module load Trinity/2014-07-17-foss-2016b
/usr/local/apps/eb/Trinity/2014-07-17-foss-2016b/trinityrnaseq_r20140717/util/TrinityStats.pl trinity_134_test2.Trinity.fasta > Trinity_assembly.metrics

module load Bowtie2/2.3.4.1-foss-2016b
cd /lustre1/mdh72859/Denovo_Assembly/TrinityAssembly_Quality
bowtie2-build -f trinity_134_test2.Trinity.fasta Trinity_test_fasta
bowtie2 -x Trinity_test_fasta -1 fixed_138599-134_S21_L001_R1_001.cor.fq,fixed_138599-134_S21_L002_R1_001.cor.fq,fixed_138599-134_S21_L003_R1_001.cor.fq,fixed_138599-134_S21_L004_R1_001.cor.fq -2 fixed_138599-134_S21_L001_R2_001.cor.fq,fixed_138599-134_S21_L002_R2_001.cor.fq,fixed_138599-134_S21_L003_R2_001.cor.fq,fixed_138599-134_S21_L004_R2_001.cor.fq -S Trinity_test_alignment

module load SAMtools/1.6-foss-2016b
cd /lustre1/mdh72859/Denovo_Assembly/TrinityAssembly_Quality
samtools sort -@ 4 -o Trinity_test_alignment_sorted.bam Trinity_test_alignment

/usr/local/apps/eb/Trinity/2014-07-17-foss-2016b/trinityrnaseq_r20140717/util/SAM_nameSorted_to_uniq_count_stats.pl Trinity_test_alignment_sorted.bam > /lustre1/mdh72859/Denovo_Assembly/TrinityAssembly_Quality/Trinity_alignment.statistics

#Also need to try using Detonate. Not currently supported on Sapelo/2. Submitted ticket to GACRC.
#Detonate will likely be handy in comparing one assembly to another, but also offers a means to 
#show how well an assembly is supported by its reads. What I really want to know is how well Trinity did with
#our assembly (and if the weird cluster/gene thing is a problem or not).
#There is another Trinity tool that generates contig length data incorporating expression values,
#but this first requires that transcript abundance estimation has been done.

#QA script worked on test alignment, alignment statistics pasted below:
Building a SMALL index
13718144 reads; of these:
  13718144 (100.00%) were paired; of these:
    1207501 (8.80%) aligned concordantly 0 times
    6789211 (49.49%) aligned concordantly exactly 1 time
    5721432 (41.71%) aligned concordantly >1 times
    ----
    1207501 pairs aligned concordantly 0 times; of these:
      59199 (4.90%) aligned discordantly 1 time
    ----
    1148302 pairs aligned 0 times concordantly or discordantly; of these:
      2296604 mates make up the pairs; of these:
        1817165 (79.12%) aligned 0 times
        247552 (10.78%) aligned exactly 1 time
        231887 (10.10%) aligned >1 times
93.38% overall alignment rate

#read_type	count	pct
left_only	12635926	49.32
right_only	12593249	49.16
proper_pairs	389532	1.52
improper_pairs	416	0.00

Total aligned reads: 25619123

#Doesn't seem great.